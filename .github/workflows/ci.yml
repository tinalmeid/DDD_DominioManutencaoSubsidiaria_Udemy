# .github/workflows/ci.yml

name: CI - Build, Testes e Analise de Qualidade (SonarCloud)

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout do Codigo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 2. Setup do .NET Core
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "6.0.x"

      # -----------------------------------------------------
      # 3. INICIAR ANALISE DO SONARCLOUD
      # -----------------------------------------------------

      - name: 3. Iniciar Analise do SonarCloud
        env:
          # 1. Segredo passado via variável de ambiente (Regra Sonar)
          SONAR_TOKEN_ENV: ${{ secrets.SONARCLOUD_TOKEN }}
          # 2. Variáveis de PR higienizadas (Regra Sonar anterior)
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_BRANCH: ${{ github.head_ref }}
          PR_BASE: ${{ github.base_ref }}

        run: |
          dotnet tool install --global dotnet-sonarscanner

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # Usa a variável de ambiente $SONAR_TOKEN_ENV em vez do segredo direto
            dotnet sonarscanner begin \
              /k:'DDD-DominioManutencaoSubsidiaria-Udemy' \
              /o:"tinalmeid" \
              /d:sonar.token="$SONAR_TOKEN_ENV" \
              /d:sonar.host.url="https://sonarcloud.io" \
              /d:sonar.cs.opencover.reportsPaths="test/Manutencao.SolicitacaoTestes/coverage.opencover.xml" \
              /d:sonar.pullrequest.key="$PR_NUMBER" \
              /d:sonar.pullrequest.branch="$PR_BRANCH" \
              /d:sonar.pullrequest.base="$PR_BASE"
          else
            dotnet sonarscanner begin \
              /k:'DDD-DominioManutencaoSubsidiaria-Udemy' \
              /o:"tinalmeid" \
              /d:sonar.token="$SONAR_TOKEN_ENV" \
              /d:sonar.host.url="https://sonarcloud.io" \
              /d:sonar.cs.opencover.reportsPaths="test/Manutencao.SolicitacaoTestes/coverage.opencover.xml"
          fi

      - name: 4. Build do Projeto (Compilacao)
        run: dotnet build --no-incremental

      - name: 5. Rodar Testes Unitarios e Gerar Cobertura
        run: |
          if [ -f "test/Manutencao.SolicitacaoTestes/Manutencao.SolicitacaoTestes.csproj" ]; then
            dotnet test test/Manutencao.SolicitacaoTestes/Manutencao.SolicitacaoTestes.csproj /p:CollectCoverage=true /p:CoverletOutputFormat=opencover --logger "trx;LogFileName=TestResults.trx"
          else
            echo "Projeto de testes não encontrado. Pulando etapa de testes."
          fi

      - name: 6. Finalizar Analise e Enviar ao SonarCloud
        env:
          SONAR_TOKEN_ENV: ${{ secrets.SONARCLOUD_TOKEN }}
        # Usa a variável de ambiente aqui também
        run: dotnet sonarscanner end /d:sonar.token="$SONAR_TOKEN_ENV"

      # -----------------------------------------------------

      - name: 7. Fazer Upload dos Artefatos de Build (Opcional)
        uses: actions/upload-artifact@v4
        with:
          name: api-build
          path: src/Manutencao.Solicitacao.Api/bin/Release/
